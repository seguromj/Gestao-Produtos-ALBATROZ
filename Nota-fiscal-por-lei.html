
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Profissional - Emissor Fiscal Oficial</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 30px; max-width: 1400px; margin: 0 auto; }

        .api-config { grid-column: 1 / -1; background: var(--primary); color: white; padding: 20px; border-radius: 12px; display: flex; gap: 20px; align-items: center; }
        .api-config input, .api-config select { padding: 10px; border-radius: 5px; border: none; flex: 1; }

        .editor { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .section-title { font-size: 14px; font-weight: bold; color: #7f8c8d; text-transform: uppercase; border-bottom: 1px solid #eee; margin: 20px 0 15px; padding-bottom: 5px; }
        
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 10px; }
        .form-group label { font-size: 11px; font-weight: 700; margin-bottom: 4px; }
        .form-group input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

        .product-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .product-table th { background: #f1f2f6; font-size: 11px; padding: 10px; text-align: left; }
        .product-row td { padding: 5px; }
        .product-row input { width: 100%; padding: 8px; border: 1px solid #eee; box-sizing: border-box; }

        #preview-cupom { background: white; width: 80mm; padding: 5mm; font-family: 'Courier New', monospace; font-size: 11px; color: #000; box-shadow: 0 0 15px rgba(0,0,0,0.1); margin: 0 auto; }
        .line { border-top: 1px dashed #000; margin: 5px 0; }
        .bold { font-weight: bold; }
        .center { text-align: center; }
        .flex { display: flex; justify-content: space-between; }

        .btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-emitir { background: var(--accent); color: white; width: 100%; font-size: 16px; margin-top: 20px; }
        .btn-add { background: #3498db; color: white; padding: 8px 15px; font-size: 12px; }
        .btn-print { background: #f39c12; color: white; width: 100%; margin-top: 10px; }

        .btn-voltar { background: #222; color: #fff; border: 1px solid #444; padding: 10px 20px; margin-bottom: 20px; border-radius: 8px; align-self: flex-start; cursor: pointer; flex-shrink: 0; font-size: 14px; font-weight: bold; }
        
        .btn-ncm { background: #7f8c8d; color: white; border: none; padding: 2px 5px; font-size: 10px; cursor: pointer; border-radius: 3px; display: block; margin-bottom: 2px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; width: 60%; border-radius: 10px; max-height: 80vh; overflow-y: auto; }
        .ncm-list-table { width: 100%; border-collapse: collapse; }
        .ncm-list-table th, .ncm-list-table td { border: 1px solid #ddd; padding: 10px; text-align: left; font-size: 13px; }
        .ncm-list-table tr:hover { background: #f1f1f1; cursor: pointer; }
        .search-ncm { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; }

        /* Estilos Novos: Cadastro e Backup */
        .cadastro-prod { background: #f1f2f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: flex-end; }
        .cadastro-prod input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .backup-controls { margin-top: 20px; display: flex; gap: 10px; }
        .btn-backup { background: #8e44ad; color: white; font-size: 12px; padding: 10px; }

        @media print {
            body * { visibility: hidden; }
            #preview-cupom, #preview-cupom * { visibility: visible; }
            #preview-cupom { position: absolute; left: 0; top: 0; width: 80mm; box-shadow: none; margin: 0; padding: 0; }
            .btn-voltar, .api-config, .editor, .btn, .preview-area > button, .modal { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="modalNCM" class="modal">
        <div class="modal-content">
            <h3>Gerenciar Produtos e NCM</h3>
            
            <div class="cadastro-prod">
                <div class="form-group"><label>PRODUTO</label><input type="text" id="newProdNome" placeholder="Ex: Arroz 5kg"></div>
                <div class="form-group"><label>NCM</label><input type="text" id="newProdNcm" placeholder="Ex: 10063021"></div>
                <button class="btn btn-add" onclick="cadastrarProduto()">SALVAR PRODUTO</button>
            </div>

            <input type="text" class="search-ncm" id="searchNCM" placeholder="Filtrar por nome ou código..." onkeyup="filterNCM()">
            <table class="ncm-list-table" id="ncmTable">
                <thead><tr><th>NCM</th><th>DESCRIÇÃO</th><th>AÇÃO</th></tr></thead>
                <tbody id="ncmTableBody">
                    </tbody>
            </table>
            <br>
            <button onclick="document.getElementById('modalNCM').style.display='none'">Fechar</button>
        </div>
    </div>

    <div class="main-grid">
        <button class="btn-voltar" onclick="location.href='index.html'">← VOLTAR</button>
        <div class="api-config">
            <div><strong>MODO:</strong><br>
                <select id="apiMode">
                    <option value="producao">PRODUÇÃO (VALOR FISCAL)</option>
                    <option value="homologacao">HOMOLOGAÇÃO (TESTES)</option>
                </select>
            </div>
            <div style="flex:2;"><strong>TOKEN DA API:</strong><br>
                <input type="password" id="apiToken" placeholder="Insira seu Token FocusNFe">
            </div>
            <div style="flex:2;"><strong>URL DO SCRIPT (PLANILHA):</strong><br>
                <input type="text" id="scriptUrl" placeholder="URL do Google Apps Script">
            </div>
            <button class="btn" style="background:#2ecc71; color:white; padding:10px;" onclick="saveApiConfig()">SALVAR CONFIG</button>
        </div>

        <div class="editor">
            <div class="section-title">Dados do Emitente</div>
            <div class="grid-inputs">
                <div class="form-group"><label>RAZÃO SOCIAL</label><input type="text" id="inRazao" value="MINHA EMPRESA LTDA" oninput="updatePreview(); saveEmitente();"></div>
                <div class="form-group"><label>CNPJ</label><input type="text" id="inCnpj" value="00.000.000/0001-00" oninput="updatePreview(); saveEmitente();"></div>
                <div class="form-group"><label>INSC. ESTADUAL</label><input type="text" id="inIE" value="123456789" oninput="updatePreview(); saveEmitente();"></div>
            </div>

            <div class="section-title">Dados do Cliente (Opcional)</div>
            <div class="grid-inputs">
                <div class="form-group" style="grid-column: span 2;"><label>NOME/RAZÃO DO CLIENTE</label><input type="text" id="inClienteNome" placeholder="Consumidor Final" oninput="updatePreview()"></div>
                <div class="form-group"><label>CPF/CNPJ</label><input type="text" id="inClienteDoc" placeholder="000.000.000-00" oninput="updatePreview()"></div>
            </div>

            <div class="section-title">Itens da Venda</div>
            <table class="product-table">
                <thead>
                    <tr>
                        <th>DESCRIÇÃO</th>
                        <th width="80"><button class="btn-ncm" onclick="document.getElementById('modalNCM').style.display='block'">BUSCAR</button>NCM</th>
                        <th width="60">QTD</th>
                        <th width="100">VALOR UN.</th>
                        <th width="40"></th>
                    </tr>
                </thead>
                <tbody id="productItems"></tbody>
            </table>
            <button class="btn btn-add" onclick="addProductRow()">+ NOVO PRODUTO</button>

            <div class="backup-controls">
                <button class="btn btn-backup" onclick="exportarBackup()">BAIXAR BACKUP PRODUTOS</button>
                <button class="btn btn-backup" onclick="document.getElementById('importFile').click()">IMPORTAR BACKUP</button>
                <input type="file" id="importFile" style="display:none" onchange="importarBackup(event)">
            </div>

            <div class="section-title">Dados Fiscais (Retorno SEFAZ)</div>
            <div class="grid-inputs">
                <div class="form-group"><label>STATUS</label><input type="text" id="inStatus" value="AGUARDANDO TRANSMISSÃO" oninput="updatePreview()"></div>
                <div class="form-group"><label>DATA/HORA</label><input type="datetime-local" id="inData" oninput="updatePreview()"></div>
                <div class="form-group"><label>PROTOCOLO</label><input type="text" id="inProtocolo" value="---" oninput="updatePreview()"></div>
                <div class="form-group" style="grid-column: span 3;"><label>CHAVE DE ACESSO</label><input type="text" id="inChave" placeholder="Gerado automaticamente" oninput="updatePreview()"></div>
            </div>

            <div class="section-title">Pagamento</div>
            <div class="grid-inputs">
                <div class="form-group">
                    <label>FORMA</label>
                    <select id="inPagamento" onchange="updatePreview()">
                        <option value="01">Dinheiro</option>
                        <option value="03">Cartão de Crédito</option>
                        <option value="17">PIX</option>
                    </select>
                </div>
                <div class="form-group"><label>IMPOSTOS APROX.</label><input type="text" id="inImposto" value="R$ 0,00" oninput="updatePreview()"></div>
            </div>

            <button class="btn btn-emitir" onclick="emitirNotaOficial()">EMITIR E SALVAR NA PLANILHA</button>
        </div>

        <div class="preview-area">
            <div id="preview-cupom">
                <div class="center bold" id="outRazao">EMPRESA</div>
                <div class="center" id="outCnpj">CNPJ</div>
                <div class="line"></div>
                <div class="center bold">CUPOM FISCAL ELETRÔNICO</div>
                <div class="center" id="statusNota">AGUARDANDO</div>
                <div class="line"></div>
                <div id="outListItems"></div>
                <div class="line"></div>
                <div class="flex bold"><span>TOTAL R$</span> <span id="outTotalGeral">0,00</span></div>
                <div class="flex"><span>FORMA PAGTO:</span> <span id="outPagto">Dinheiro</span></div>
                <div class="line"></div>
                <div class="center">
                    <span id="outData">--</span><br>
                    <span id="outChave" style="font-size:8px;">---</span>
                </div>
                <div class="barcode-container" style="text-align:center;"><svg id="barcode"></svg></div>
                <div class="qrcode-container" id="qrcode" style="display:flex; justify-content:center;"></div>
            </div>
            <button class="btn btn-print" onclick="window.print()">IMPRIMIR CUPOM (80mm)</button>
            <button class="btn" style="width:100%; margin-top:10px; background:#34495e; color:white;" onclick="baixarPDF()">SALVAR PDF</button>
        </div>
    </div>

    <script>
        let productCount = 0;
        let dbProdutos = JSON.parse(localStorage.getItem('meusProdutos')) || [
            {ncm: '10063021', nome: 'Arroz Polido'},
            {ncm: '22021000', nome: 'Refrigerantes'},
            {ncm: '22072019', nome: 'Álcool Etílico'},
            {ncm: '85171300', nome: 'Smartphones'}
        ];

        function addProductRow() {
            productCount++;
            const row = document.createElement('tr');
            row.className = 'product-row';
            row.id = `item-${productCount}`;
            row.innerHTML = `
                <td><input type="text" class="p-desc" value="PRODUTO ${productCount}" oninput="updatePreview()"></td>
                <td><input type="text" class="p-ncm" value="22072019" oninput="updatePreview()"></td>
                <td><input type="number" class="p-qtd" value="1" oninput="updatePreview()"></td>
                <td><input type="text" class="p-valor" value="10.00" oninput="updatePreview()"></td>
                <td><button onclick="document.getElementById('item-${productCount}').remove(); updatePreview();">x</button></td>
            `;
            document.getElementById('productItems').appendChild(row);
            updatePreview();
        }

        function filterNCM() {
            let input = document.getElementById('searchNCM');
            let filter = input.value.toUpperCase();
            let table = document.getElementById('ncmTable');
            let tr = table.getElementsByTagName('tr');
            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td');
                if (td.length > 0) {
                    let text = td[0].innerText + td[1].innerText;
                    tr[i].style.display = text.toUpperCase().indexOf(filter) > -1 ? "" : "none";
                }
            }
        }

        function cadastrarProduto() {
            const nome = document.getElementById('newProdNome').value;
            const ncm = document.getElementById('newProdNcm').value;
            if(!nome || !ncm) return alert("Preencha nome e NCM!");
            
            dbProdutos.push({ncm: ncm, nome: nome});
            localStorage.setItem('meusProdutos', JSON.stringify(dbProdutos));
            renderTabelaNCM();
            document.getElementById('newProdNome').value = '';
            document.getElementById('newProdNcm').value = '';
        }

        function renderTabelaNCM() {
            const tbody = document.getElementById('ncmTableBody');
            tbody.innerHTML = '';
            dbProdutos.forEach((item, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td onclick="selectNCM('${item.ncm}', '${item.nome}')">${item.ncm}</td>
                        <td onclick="selectNCM('${item.ncm}', '${item.nome}')">${item.nome}</td>
                        <td><button onclick="removerProduto(${index})" style="color:red">X</button></td>
                    </tr>
                `;
            });
        }

        function removerProduto(index) {
            if(confirm("Excluir este produto?")) {
                dbProdutos.splice(index, 1);
                localStorage.setItem('meusProdutos', JSON.stringify(dbProdutos));
                renderTabelaNCM();
            }
        }

        function selectNCM(ncm, nome) {
            const rows = document.querySelectorAll('.product-row');
            if(rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                lastRow.querySelector('.p-ncm').value = ncm;
                lastRow.querySelector('.p-desc').value = nome;
            }
            document.getElementById('modalNCM').style.display = 'none';
            updatePreview();
        }

        function exportarBackup() {
            const data = JSON.stringify(dbProdutos);
            const blob = new Blob([data], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'backup_produtos.json';
            a.click();
        }

        function importarBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(Array.isArray(imported)) {
                        dbProdutos = imported;
                        localStorage.setItem('meusProdutos', JSON.stringify(dbProdutos));
                        renderTabelaNCM();
                        alert("Backup importado com sucesso!");
                    }
                } catch(err) { alert("Arquivo inválido!"); }
            };
            reader.readAsText(file);
        }

        // Funções para Salvar/Carregar Dados do Emitente
        function saveEmitente() {
            const emitente = {
                razao: document.getElementById('inRazao').value,
                cnpj: document.getElementById('inCnpj').value,
                ie: document.getElementById('inIE').value
            };
            localStorage.setItem('dadosEmitente', JSON.stringify(emitente));
        }

        function loadEmitente() {
            const saved = JSON.parse(localStorage.getItem('dadosEmitente'));
            if (saved) {
                document.getElementById('inRazao').value = saved.razao;
                document.getElementById('inCnpj').value = saved.cnpj;
                document.getElementById('inIE').value = saved.ie;
            }
        }

        // NOVAS FUNÇÕES: Salvar e Carregar Configurações de API
        function saveApiConfig() {
            const config = {
                token: document.getElementById('apiToken').value,
                url: document.getElementById('scriptUrl').value,
                modo: document.getElementById('apiMode').value
            };
            localStorage.setItem('configApi', JSON.stringify(config));
            alert("Configurações de API salvas!");
        }

        function loadApiConfig() {
            const saved = JSON.parse(localStorage.getItem('configApi'));
            if (saved) {
                document.getElementById('apiToken').value = saved.token || "";
                document.getElementById('scriptUrl').value = saved.url || "";
                document.getElementById('apiMode').value = saved.modo || "homologacao";
            }
        }

        function updatePreview() {
            document.getElementById('outRazao').innerText = document.getElementById('inRazao').value;
            document.getElementById('outCnpj').innerText = "CNPJ: " + document.getElementById('inCnpj').value;
            document.getElementById('outPagto').innerText = document.getElementById('inPagamento').options[document.getElementById('inPagamento').selectedIndex].text;
            document.getElementById('statusNota').innerText = document.getElementById('inStatus').value;
            
            // Tratamento da Data no Preview
            const dataVal = document.getElementById('inData').value;
            if(dataVal) {
                const d = new Date(dataVal);
                document.getElementById('outData').innerText = d.toLocaleString('pt-BR');
            }

            document.getElementById('outChave').innerText = document.getElementById('inChave').value;

            const descs = document.querySelectorAll('.p-desc');
            const qtds = document.querySelectorAll('.p-qtd');
            const valores = document.querySelectorAll('.p-valor');
            const outList = document.getElementById('outListItems');
            
            let total = 0;
            outList.innerHTML = '';
            descs.forEach((d, i) => {
                const sub = (parseFloat(qtds[i].value) || 0) * (parseFloat(valores[i].value) || 0);
                total += sub;
                outList.innerHTML += `<div class="flex"><span>${d.value.toUpperCase()}</span> <span>${sub.toFixed(2)}</span></div>`;
            });
            document.getElementById('outTotalGeral').innerText = total.toFixed(2);
            
            let ch = document.getElementById('inChave').value.replace(/\s/g, '');
            if(ch.length === 44) renderFiscalCodes(ch);
        }

        async function emitirNotaOficial() {
            const scriptUrl = document.getElementById('scriptUrl').value;
            const token = document.getElementById('apiToken').value;
            if(!scriptUrl || !token) return alert("Configure a URL do Script e o Token!");

            const btn = document.querySelector('.btn-emitir');
            btn.innerText = "PROCESSANDO..."; btn.disabled = true;

            const itens = [];
            document.querySelectorAll('.product-row').forEach(row => {
                itens.push({
                    nome: row.querySelector('.p-desc').value,
                    ncm: row.querySelector('.p-ncm').value,
                    quantidade: row.querySelector('.p-qtd').value,
                    valor_unitario: row.querySelector('.p-valor').value
                });
            });

            const dadosVenda = {
                token: token,
                ambiente: document.getElementById('apiMode').value === 'producao' ? '1' : '2',
                cliente_nome: document.getElementById('inClienteNome').value,
                cliente_cpf: document.getElementById('inClienteDoc').value,
                pagamento: document.getElementById('inPagamento').value,
                itens: itens
            };

            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: JSON.stringify(dadosVenda)
                });
                const result = await response.json();

                if(result.status === 'autorizado') {
                    document.getElementById('inChave').value = result.chave;
                    document.getElementById('inProtocolo').value = result.protocolo;
                    // Atualiza o input datetime-local com o momento da autorização
                    const agora = new Date();
                    agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
                    document.getElementById('inData').value = agora.toISOString().slice(0, 16);
                    
                    document.getElementById('inStatus').value = "EMITIDA COM SUCESSO";
                    updatePreview();
                    alert("NOTA FISCAL VÁLIDA E SALVA NA PLANILHA!");
                } else {
                    alert("Erro SEFAZ: " + result.mensagem);
                }
            } catch (e) {
                alert("Erro na conexão com o Script da Planilha.");
            } finally {
                btn.innerText = "EMITIR E SALVAR NA PLANILHA"; btn.disabled = false;
            }
        }

        function renderFiscalCodes(chave) {
            JsBarcode("#barcode", chave, { format: "CODE128", width: 1.1, height: 40, displayValue: false });
            document.getElementById("qrcode").innerHTML = "";
            new QRCode(document.getElementById("qrcode"), { text: "https://www.nfce.fazenda.sp.gov.br/consulta?chNFe=" + chave, width: 100, height: 100 });
        }

        function baixarPDF() {
            html2pdf().from(document.getElementById('preview-cupom')).save();
        }

        // Inicialização
        loadEmitente();
        loadApiConfig(); // Carrega o Token e a URL salvos anteriormente
        renderTabelaNCM();
        addProductRow();

        // Define a data atual no input ao carregar
        const agora = new Date();
        agora.setMinutes(agora.getMinutes() - agora.getTimezoneOffset());
        document.getElementById('inData').value = agora.toISOString().slice(0, 16);
        updatePreview();
    </script>
</body>
</html>

